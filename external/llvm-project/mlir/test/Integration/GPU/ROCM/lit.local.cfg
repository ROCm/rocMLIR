import subprocess

if not config.enable_rocm_runner:
  config.unsupported = True

# Need to specify the chip sub-option to the gpu-to-hsaco pass, and also check
# that we have a gpu at all.  Use rocm_agent_enumerator to find the chip and
# use %chip to insert it, and if no chip is found, mark the test unsupported.
# Even though the tests here use mlir-cpu-runner, they still call mgpu
# functions.
config.chip = 'gfx000'
if config.rocm_path:
   try:
       p = subprocess.run([config.rocm_path + "/bin/rocm_agent_enumerator"],
                          check=True, stdout=subprocess.PIPE)
       agents = [x for x in p.stdout.split() if x != b'gfx000']
       if agents:
           config.chip = agents[0].decode('utf-8')
       else:
           config.unsupported = True
   except subprocess.CalledProcessError:
       config.unsupported = True
config.substitutions.append(('%chip', config.chip))
