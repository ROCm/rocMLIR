# IREE-rocMLIR integration

The IREE-rocMLIR integration project is a prototype on using IREE as kernel
generator for rocMLIR. This project is meant to elucidate integration challenges
between MIGraphX and IREE, as well as testing IREE's kernel performance.

### Design

This section discusses the design of the prototype, as well as important
configuration parameters.

By default rocMLIR will try to use IREE as the kernel generator. However,
it is important to note that if IREE fails to compile the kernel for any
reason, then the usual kernel generated by rocMLIR will be used as fallback.


#### Compilation pipeline
Input: an MLIR module containing `migraphx` operations.
- After `migraphx-to-tosa`, the pipeline invokes the pass `migraphx-iree-gen`.
This pass invokes the `iree-export.py` tool, collects the results produced by
IREE, and stores them in the `iree.export` attribute in the top `built.module`.
- After `gpu-module-to-binary`, the pipeline invokes the pass `rock-iree-merge`.
This pass searches the `iree.export` attribute and upon success updates the
respective `gpu.binary` and `gpu.launch_func` operations with the data generated
by IREE.

#### Environment configuration
The following environment variables allow configuring the behavior of the
prototype:
- `IREE_BIN`[required]: Path to the folder containing `iree-compile`.
- `IREE_DEBUG`[optional]: Debug level, 0 means no debug, 1 means basic debugging,
    and 2 means print all debug messages.
- `IREE_CONFIG`[optional]: Path to a YAML file with a list of extra flags to pass
to `iree-compile`. See the `iree-rocMLIR/iree-config.yaml` for an example of a
configuration file.
- `IREE_DISABLE`[optional]: If `IREE_DISABLE=1`, then IREE won't be invoked.

## Building
To build the `iree-rocMLIR` integration the following projects are needed:

- [AMDMIGraphX commit 059819d](https://github.com/ROCm/AMDMIGraphX/commit/059819d0d5ecbb4ea67efc6f907eb6c9a98f59b7) and patched with `iree-rocMLIR/migraphx.patch`
- [IREE commit 0934526](https://github.com/iree-org/iree/commit/0934526e288315552650554da12d49b94845c7bf) and patched with `iree-rocMLIR/iree.patch`

**The `iree-rocMLIR/setup.sh` script provides a recipe on how to build the project.** It also provides a script for configuring `IREE_BIN`.

Note: Building MIGraphX requires `root` privileges for installing various pre-requisites.

To run the script use:
```bash
# Build and install everything under ${HOME}/iree-rocMLIR 
export ROOT_DIR=${HOME}/iree-rocMLIR
./setup.sh all
```

The script also allows calling specific functions, for example:
```bash
# Only setup build directories
./setup.sh setup_dirs
# Clone rocMLIR
./setup.sh clone_rocMLIR
# Clone MIGraphX
./setup.sh clone_MIGraphX
# Build IREE
./setup.sh build_iree
```

## Example:

```bash
source ${HOME}/iree-rocMLIR/setup.sh

export MIGRAPHX_ENABLE_MLIR=1
export IREE_BIN="${HOME}/iree-rocMLIR/bin"
export IREE_DISABLE=0
export IREE_DEBUG=1
export IREE_CONFIG="${HOME}/iree-rocMLIR/config/iree-config.yaml"

migraphx-driver perf --onnx model.onnx
```
