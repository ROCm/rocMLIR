// RUN: mlir-opt -miopen-affine-transform %s | FileCheck %s

module  {
  func @miopen_conv2d_gkcyx_ngchw_ngkhw_0(%arg0: memref<1x128x8x3x3xf32>, %arg1: memref<128x1x8x32x32xf32>, %arg2: memref<128x1x128x30x30xf32>) attributes {kernel = 0 : i32} {
    %0 = miopen.transform(%arg0) {lower_layer_bounds = [1 : i32, 128 : i32, 8 : i32, 3 : i32, 3 : i32], extraPad = false, gemmKExtra = 0 : i32, gemmMExtra = 0 : i32, gridwise_gemm_argument_position = 0 : i32, layout = [{upper_layer_dimensions = [0 : i32], upper_layer_names = ["gemmG"], lower_layer_dimensions = [0 : i32], lower_layer_names = ["g"], transformation = "PassThrough"}, {upper_layer_dimensions = [1 : i32], upper_layer_names = ["gemmK"], lower_layer_dimensions = [2 : i32, 3 : i32, 4 : i32], lower_layer_names = ["c", "y", "x"], transformation = "Unfold"}, {upper_layer_dimensions = [2 : i32], upper_layer_names = ["gemmM"], lower_layer_dimensions = [1 : i32], lower_layer_names = ["k"], transformation = "PassThrough"}], upper_layer_layout = ["gemmG", "gemmK", "gemmM"], upper_layer_bounds = [1 : i32, 72 : i32, 128 : i32], lower_layer_layout = ["g", "k", "c", "y", "x"]} : memref<1x128x8x3x3xf32> to memref<1x72x128xf32>
    %1 = miopen.transform(%arg1) {lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32], extraPad = false, gemmKExtra = 0 : i32, gemmNExtra = 0 : i32, layout = [{upper_layer_dimensions = [1 : i32], upper_layer_names = ["gi"], lower_layer_dimensions = [1 : i32], lower_layer_names = ["gi"], transformation = "PassThrough"}, {upper_layer_dimensions = [0 : i32], upper_layer_names = ["ni"], lower_layer_dimensions = [0 : i32], lower_layer_names = ["ni"], transformation = "PassThrough"}, {upper_layer_dimensions = [2 : i32], upper_layer_names = ["ci"], lower_layer_dimensions = [2 : i32], lower_layer_names = ["ci"], transformation = "PassThrough"}, {upper_layer_dimensions = [3 : i32, 4 : i32], upper_layer_names = ["hipad", "wipad"], parameters = [0 : i32, 0 : i32, 0 : i32, 0 : i32], lower_layer_dimensions = [3 : i32, 4 : i32], lower_layer_names = ["hi", "wi"], transformation = "Pad"}], upper_layer_layout = ["ni", "gi", "ci", "hipad", "wipad"], upper_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32], lower_layer_layout = ["ni", "gi", "ci", "hi", "wi"]} : memref<128x1x8x32x32xf32> to memref<128x1x8x32x32xf32>
    %2 = miopen.transform(%1) {lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32], lower_layer_layout = ["ni", "gi", "ci", "hipad", "wipad"], layout = [{upper_layer_dimensions = [1 : i32], upper_layer_names = ["gi"], lower_layer_dimensions = [1 : i32], lower_layer_names = ["gi"], transformation = "PassThrough"}, {upper_layer_dimensions = [0 : i32], upper_layer_names = ["ni"], lower_layer_dimensions = [0 : i32], lower_layer_names = ["ni"], transformation = "PassThrough"}, {upper_layer_dimensions = [2 : i32], upper_layer_names = ["ci"], lower_layer_dimensions = [2 : i32], lower_layer_names = ["ci"], transformation = "PassThrough"}, {upper_layer_dimensions = [3 : i32, 4 : i32], upper_layer_names = ["y", "ho"], parameters = [1 : i32, 1 : i32, 1 : i32, 0 : i32], lower_layer_dimensions = [3 : i32], lower_layer_names = ["hipad"], transformation = "Embed"}, {upper_layer_dimensions = [5 : i32, 6 : i32], upper_layer_names = ["x", "wo"], parameters = [1 : i32, 1 : i32, 1 : i32, 0 : i32], lower_layer_dimensions = [4 : i32], lower_layer_names = ["wipad"], transformation = "Embed"}], upper_layer_layout = ["ni", "gi", "ci", "y", "ho", "x", "wo"], upper_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 3 : i32, 30 : i32, 3 : i32, 30 : i32]} : memref<128x1x8x32x32xf32> to memref<128x1x8x3x30x3x30xf32>
    %3 = miopen.transform(%2) {lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 3 : i32, 30 : i32, 3 : i32, 30 : i32], gridwise_gemm_argument_position = 1 : i32, lower_layer_layout = ["ni", "gi", "ci", "y", "ho", "x", "wo"], layout = [{upper_layer_dimensions = [0 : i32], upper_layer_names = ["gemmG"], lower_layer_dimensions = [1 : i32], lower_layer_names = ["gi"], transformation = "PassThrough"}, {upper_layer_dimensions = [1 : i32], upper_layer_names = ["gemmK"], lower_layer_dimensions = [2 : i32, 3 : i32, 5 : i32], lower_layer_names = ["ci", "y", "x"], transformation = "Merge"}, {upper_layer_dimensions = [2 : i32], upper_layer_names = ["gemmN"], lower_layer_dimensions = [0 : i32, 4 : i32, 6 : i32], lower_layer_names = ["ni", "ho", "wo"], transformation = "Merge"}], upper_layer_layout = ["gemmG", "gemmK", "gemmN"], upper_layer_bounds = [1 : i32, 72 : i32, 115200 : i32]} : memref<128x1x8x3x30x3x30xf32> to memref<1x72x115200xf32>
    %4 = miopen.transform(%arg2) {lower_layer_bounds = [128 : i32, 1 : i32, 128 : i32, 30 : i32, 30 : i32], extraPad = false, gemmMExtra = 0 : i32, gemmNExtra = 0 : i32, gridwise_gemm_argument_position = 2 : i32, layout = [{upper_layer_dimensions = [0 : i32], upper_layer_names = ["gemmG"], lower_layer_dimensions = [1 : i32], lower_layer_names = ["go"], transformation = "PassThrough"}, {upper_layer_dimensions = [1 : i32], upper_layer_names = ["gemmM"], lower_layer_dimensions = [2 : i32], lower_layer_names = ["ko"], transformation = "PassThrough"}, {upper_layer_dimensions = [2 : i32], upper_layer_names = ["gemmN"], lower_layer_dimensions = [0 : i32, 3 : i32, 4 : i32], lower_layer_names = ["no", "ho", "wo"], transformation = "Merge"}], upper_layer_layout = ["gemmG", "gemmM", "gemmN"], upper_layer_bounds = [1 : i32, 128 : i32, 115200 : i32], lower_layer_layout = ["no", "go", "ko", "ho", "wo"]} : memref<128x1x128x30x30xf32> to memref<1x128x115200xf32>
    miopen.gridwise_gemm(%0, %3, %4) {arch = "gfx906", dilations = [1 : i32, 1 : i32], filter_dimension = [1, 128, 8, 3, 3], filter_layout = ["g", "k", "c", "y", "x"], input_dimension = [128, 1, 8, 32, 32], input_layout = ["ni", "gi", "ci", "hi", "wi"], kernel_algorithm = "v4r4", num_cu = 64 : i32, output_dimension = [128, 1, 128, 30, 30], upper_layer_layout = ["no", "go", "ko", "ho", "wo"], padding = [0 : i32, 0 : i32, 0 : i32, 0 : i32], strides = [1 : i32, 1 : i32]} : memref<1x72x128xf32>, memref<1x72x115200xf32>, memref<1x128x115200xf32>
    return
  }
}
// CHECK-LABEL: func @miopen_conv2d_gkcyx_ngchw_ngkhw_0
//  CHECK-NEXT: %{{.*}} = miopen.transform(%{{.*}}) {{{.*}}lower_layer_bounds = [1 : i32, 128 : i32, 8 : i32, 3 : i32, 3 : i32]{{.*}}, upper_layer_bounds = [1 : i32, 72 : i32, 128 : i32]{{.*}}} : memref<1x128x8x3x3xf32> to memref<1x72x128xf32, #{{.*}}>
//  CHECK-NEXT: %{{.*}} = miopen.transform(%{{.*}}) {{{.*}}lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32]{{.*}}, upper_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32]{{.*}}} : memref<128x1x8x32x32xf32> to memref<128x1x8x32x32xf32>
//  CHECK-NEXT: %{{.*}} = miopen.transform(%{{.*}}) {{{.*}}lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 32 : i32, 32 : i32]{{.*}}, upper_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 3 : i32, 30 : i32, 3 : i32, 30 : i32]{{.*}}} : memref<128x1x8x32x32xf32> to memref<128x1x8x3x30x3x30xf32, #{{.*}}>
//  CHECK-NEXT: %{{.*}} = miopen.transform(%{{.*}}) {{{.*}}lower_layer_bounds = [128 : i32, 1 : i32, 8 : i32, 3 : i32, 30 : i32, 3 : i32, 30 : i32]{{.*}}, upper_layer_bounds = [1 : i32, 72 : i32, 115200 : i32]{{.*}}} : memref<128x1x8x3x30x3x30xf32, #{{.*}}> to memref<1x72x115200xf32, #{{.*}}, #{{.*}}>
//  CHECK-NEXT: %{{.*}} = miopen.transform(%{{.*}}) {{{.*}}lower_layer_bounds = [128 : i32, 1 : i32, 128 : i32, 30 : i32, 30 : i32]{{.*}}, upper_layer_bounds = [1 : i32, 128 : i32, 115200 : i32]{{.*}}} : memref<128x1x128x30x30xf32> to memref<1x128x115200xf32, #{{.*}}>
